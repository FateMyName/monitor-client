<html>
<head>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script
            type="text/javascript"
            src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"
    ></script>

    <style>
        body {
            margin: 0;
        }
        #mynetwork {
            width: 100%;
            height: 100vh;
            background: rgb(243 243 243);
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div id="mynetwork"></div>

<script type="text/javascript">
    const url = new URL(window.location.href)
    const version = parseInt(url.searchParams.get('version'))
    console.log("Version", version)
    const monitorServerUrl = "http://localhost:3000/api"
    // const monitorServerUrl = window.origin + '/api'
    console.log("Monitor server", monitorServerUrl)
    const G  = {}
    G.VW = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
    G.VH = Math.max(
        document.documentElement.clientHeight,
        window.innerHeight || 0
    )

    G.R = 100
    // G.X = G.VW / 2
    // G.Y = G.VH / 2
    G.X = 0
    G.Y = 0
    G.nodeRadius = 200
    G.maxId = parseInt('ffff', 16)
    let n = 0
    let tracker = {}
    let maxN = 0
    let C = 150
    function calculateNetworkPosition(nodeId, totalNodeCount) {
        // let spread = 12
        let spread = 4
        let angle = 137.508

        let phi = angle * Math.PI / 180
        let idRatio = parseInt((nodeId / G.maxId) * totalNodeCount)
        if (tracker[idRatio]) {
            idRatio = maxN + 1
        }
        tracker[idRatio] = true
        if (idRatio > maxN) maxN = idRatio
        n = idRatio
        let r = spread * Math.sqrt(n) + C
        const theta = n * phi
        const x = r * Math.cos(theta) + G.X
        const y = r * Math.sin(theta) + G.Y
        n += 1
        return {
            x,
            y,
            degree: angle * n
        }
    }
    const radiusTracker = {}
    for (let i = 0; i < 360; i++) {
        radiusTracker[i] = G.R
    }
    function randomIntFromInterval(min, max) { // min and max included
        return Math.floor(Math.random() * (max - min + 1) + min)
    }
    function calculateNetworkPositionNew(nodeId, totalNodeCount) {
        // let spread = 12
        let spread = 4
        let idRatio = nodeId / G.maxId
        let angle = idRatio * 360
        let nearestAngle = parseInt(angle)
        const theta = nearestAngle * Math.PI / 180
        const r = G.R + radiusTracker[nearestAngle] + randomIntFromInterval(-7, 7)
        const x = r * Math.cos(theta) + G.X
        const y = r * Math.sin(theta) + G.Y
        radiusTracker[nearestAngle] += 20
        return {
            x,
            y,
            degree: angle
        }
    }

    function generateRandomColor() {
        let n = (Math.random() * 0xfffff * 1000000).toString(16);
        return '#' + n.slice(0, 6);
    }
    function htmlTitle(html) {
        const container = document.createElement("div");
        container.innerHTML = html;
        return container;
    }
    async function start() {
        const url = new URL(window.location.href)
        const totalNodes = url.searchParams.get('count') || window.location.href
        let VW = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
        let VH = Math.max(
            document.documentElement.clientHeight,
            window.innerHeight || 0
        )
        console.log(VW, VH)
        let res = await axios.get(`${monitorServerUrl}/mock?count=${totalNodes}`)
        let activeNodes = res.data.map((n) => {
            let position
            if (version === 1) {
                console.log("Using layout 1")
                position = calculateNetworkPosition(parseInt(n.nodeId.substr(0,4), 16), res.data.length)
            } else {
                console.log("Using layout 2")
                position = calculateNetworkPositionNew(parseInt(n.nodeId.substr(0,4), 16), res.data.length)
            }
            return {
                // id: parseInt(n.nodeId.substr(0,8), 16),
                id: n.nodeId,
                x: position.x,
                y: position.y,
                physics: false,
                title: htmlTitle(`
            <p><strong>Position</strong>: ${position.x}, ${position.y}</p>
            <p><strong>NodeId</strong>: ${n.nodeId}</p>
            <p><strong>IP Address</strong>: ${n.nodeIpInfo.externalIp}:${n.nodeIpInfo.externalPort}</p>
            <p><strong>NodeList Hash</strong>: ${n.nodelistHash}</p>
            <p><strong>CycleMaker Hash</strong>: ${n.cycleMarker}</p>
            `),
                color: `#${n.appState.substr(0, 6)}`,
                interaction: {
                    tooltipDelay: 200,
                    hideEdgesOnDrag: true,
                },
            }
        })
        console.log('activeNodes', activeNodes)
        let nodes = new vis.DataSet(activeNodes)

        // create a network
        const container = document.getElementById('mynetwork')

        // provide the data in the vis format
        const data = {
            nodes: nodes
        }
        const options = {
            nodes: {
                shape: 'dot',
                size: 2,
                font: {
                    size: 12,
                    face: 'Arial'
                }
            }
        }

        // initialize your network!
        let network = new vis.Network(container, data, options)
        network.on("click", function (params) {
            const nodeId = params.nodes[0]
            nodes.update({id: nodeId, color: "red"})
        })

        setInterval(() => {
            const randomNodes = []
            for (let i =0; i < activeNodes.length / 2; i++) {
                const index = Math.round(Math.random() * activeNodes.length)
                randomNodes.push(activeNodes[index])
            }
            const updateArr = randomNodes.map(n => ({
                id: n.id,
                color: generateRandomColor()
            }))
            nodes.update(updateArr)
        }, 5000)

    }
    start()
</script>
</body>
</html>
